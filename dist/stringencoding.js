'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.decode = decode;
exports.encode = encode;
/* eslint-disable camelcase */

var ERROR_SYMBOL = 0xFFFD;

var EOF_byte = -1;
var EOF_code_point = -1;

function ByteInputStream(bytes) {
  var pos = 0;

  this.get = function () {
    return pos >= bytes.length ? EOF_byte : Number(bytes[pos]);
  };

  this.offset = function (n) {
    pos += n;
    if (pos < 0) {
      throw new Error('Seeking past start of the buffer');
    }
    if (pos > bytes.length) {
      throw new Error('Seeking past EOF');
    }
  };
}

function ByteOutputStream(bytes) {
  var pos = 0;

  this.emit = function (var_args) {
    var last = EOF_byte;
    var i;
    for (i = 0; i < arguments.length; ++i) {
      last = Number(arguments[i]);
      bytes[pos++] = last;
    }
    return last;
  };
}

function CodePointInputStream(string) {
  function stringToCodePoints(string) {
    var cps = [];
    var i = 0;
    var n = string.length;
    while (i < string.length) {
      var c = string.charCodeAt(i);
      if (!inRange(c, 0xD800, 0xDFFF)) {
        cps.push(c);
      } else if (inRange(c, 0xDC00, 0xDFFF)) {
        cps.push(0xFFFD);
      } else {
        // (inRange(cu, 0xD800, 0xDBFF))
        if (i === n - 1) {
          cps.push(0xFFFD);
        } else {
          var d = string.charCodeAt(i + 1);
          if (inRange(d, 0xDC00, 0xDFFF)) {
            var a = c & 0x3FF;
            var b = d & 0x3FF;
            i += 1;
            cps.push(0x10000 + (a << 10) + b);
          } else {
            cps.push(0xFFFD);
          }
        }
      }
      i += 1;
    }
    return cps;
  }

  var pos = 0;
  var cps = stringToCodePoints(string);

  this.offset = function (n) {
    pos += n;
    if (pos < 0) {
      throw new Error('Seeking past start of the buffer');
    }
    if (pos > cps.length) {
      throw new Error('Seeking past EOF');
    }
  };

  this.get = function () {
    if (pos >= cps.length) {
      return EOF_code_point;
    }
    return cps[pos];
  };
}

function CodePointOutputStream() {
  var string = '';

  this.string = function () {
    return string;
  };

  this.emit = function (c) {
    if (c <= 0xFFFF) {
      string += String.fromCharCode(c);
    } else {
      c -= 0x10000;
      string += String.fromCharCode(0xD800 + (c >> 10 & 0x3ff));
      string += String.fromCharCode(0xDC00 + (c & 0x3ff));
    }
  };
}

function decode(bytes) {
  var decoder = new UTF8Decoder();
  var input_stream = new ByteInputStream(bytes);
  var output_stream = new CodePointOutputStream();

  while (input_stream.get() !== EOF_byte) {
    var _code_point = decoder.decode(input_stream);
    if (_code_point !== null && _code_point !== EOF_code_point) {
      output_stream.emit(_code_point);
    }
  }

  var code_point = void 0;
  do {
    code_point = decoder.decode(input_stream);
    if (code_point !== null && code_point !== EOF_code_point) {
      output_stream.emit(code_point);
    }
  } while (code_point !== EOF_code_point && input_stream.get() !== EOF_byte);

  var result = output_stream.string();
  if (result.charCodeAt(0) === 0xFEFF) {
    result = result.substring(1);
  }

  return result;
}

function encode(opt_string) {
  var encoder = new UTF8Encoder();

  var bytes = [];
  var output_stream = new ByteOutputStream(bytes);
  var input_stream = new CodePointInputStream(opt_string);
  while (input_stream.get() !== EOF_code_point) {
    encoder.encode(output_stream, input_stream);
  }
  var last_byte;
  do {
    last_byte = encoder.encode(output_stream, input_stream);
  } while (last_byte !== EOF_byte);
  return new Uint8Array(bytes);
}

function UTF8Decoder() {
  var utf8_code_point = 0;
  var utf8_bytes_needed = 0;
  var utf8_bytes_seen = 0;
  var utf8_lower_boundary = 0;

  this.decode = function (byte_pointer) {
    var bite = byte_pointer.get();
    if (bite === EOF_byte) {
      if (utf8_bytes_needed !== 0) {
        return ERROR_SYMBOL;
      }
      return EOF_code_point;
    }
    byte_pointer.offset(1);

    if (utf8_bytes_needed === 0) {
      if (inRange(bite, 0x00, 0x7F)) {
        return bite;
      }
      if (inRange(bite, 0xC2, 0xDF)) {
        utf8_bytes_needed = 1;
        utf8_lower_boundary = 0x80;
        utf8_code_point = bite - 0xC0;
      } else if (inRange(bite, 0xE0, 0xEF)) {
        utf8_bytes_needed = 2;
        utf8_lower_boundary = 0x800;
        utf8_code_point = bite - 0xE0;
      } else if (inRange(bite, 0xF0, 0xF4)) {
        utf8_bytes_needed = 3;
        utf8_lower_boundary = 0x10000;
        utf8_code_point = bite - 0xF0;
      } else {
        return ERROR_SYMBOL;
      }
      utf8_code_point = utf8_code_point * Math.pow(64, utf8_bytes_needed);
      return null;
    }
    if (!inRange(bite, 0x80, 0xBF)) {
      utf8_code_point = 0;
      utf8_bytes_needed = 0;
      utf8_bytes_seen = 0;
      utf8_lower_boundary = 0;
      byte_pointer.offset(-1);
      return ERROR_SYMBOL;
    }
    utf8_bytes_seen += 1;
    utf8_code_point = utf8_code_point + (bite - 0x80) * Math.pow(64, utf8_bytes_needed - utf8_bytes_seen);
    if (utf8_bytes_seen !== utf8_bytes_needed) {
      return null;
    }
    var code_point = utf8_code_point;
    var lower_boundary = utf8_lower_boundary;
    utf8_code_point = 0;
    utf8_bytes_needed = 0;
    utf8_bytes_seen = 0;
    utf8_lower_boundary = 0;
    if (inRange(code_point, lower_boundary, 0x10FFFF) && !inRange(code_point, 0xD800, 0xDFFF)) {
      return code_point;
    }
    return ERROR_SYMBOL;
  };
}

function UTF8Encoder() {
  this.encode = function (output_byte_stream, code_point_pointer) {
    var code_point = code_point_pointer.get();
    if (code_point === EOF_code_point) {
      return EOF_byte;
    }
    code_point_pointer.offset(1);
    if (inRange(code_point, 0xD800, 0xDFFF)) {
      throw new Error('The code point ' + code_point + ' could not be encoded.');
    }
    if (inRange(code_point, 0x0000, 0x007f)) {
      return output_byte_stream.emit(code_point);
    }
    var count, offset;
    if (inRange(code_point, 0x0080, 0x07FF)) {
      count = 1;
      offset = 0xC0;
    } else if (inRange(code_point, 0x0800, 0xFFFF)) {
      count = 2;
      offset = 0xE0;
    } else if (inRange(code_point, 0x10000, 0x10FFFF)) {
      count = 3;
      offset = 0xF0;
    }
    var result = output_byte_stream.emit(div(code_point, Math.pow(64, count)) + offset);
    while (count > 0) {
      var temp = div(code_point, Math.pow(64, count - 1));
      result = output_byte_stream.emit(0x80 + temp % 64);
      count -= 1;
    }
    return result;
  };
}

function inRange(a, min, max) {
  return min <= a && a <= max;
}

function div(n, d) {
  return Math.floor(n / d);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdHJpbmdlbmNvZGluZy5qcyJdLCJuYW1lcyI6WyJkZWNvZGUiLCJlbmNvZGUiLCJFUlJPUl9TWU1CT0wiLCJFT0ZfYnl0ZSIsIkVPRl9jb2RlX3BvaW50IiwiQnl0ZUlucHV0U3RyZWFtIiwiYnl0ZXMiLCJwb3MiLCJnZXQiLCJsZW5ndGgiLCJOdW1iZXIiLCJvZmZzZXQiLCJuIiwiRXJyb3IiLCJCeXRlT3V0cHV0U3RyZWFtIiwiZW1pdCIsInZhcl9hcmdzIiwibGFzdCIsImkiLCJhcmd1bWVudHMiLCJDb2RlUG9pbnRJbnB1dFN0cmVhbSIsInN0cmluZyIsInN0cmluZ1RvQ29kZVBvaW50cyIsImNwcyIsImMiLCJjaGFyQ29kZUF0IiwiaW5SYW5nZSIsInB1c2giLCJkIiwiYSIsImIiLCJDb2RlUG9pbnRPdXRwdXRTdHJlYW0iLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJkZWNvZGVyIiwiVVRGOERlY29kZXIiLCJpbnB1dF9zdHJlYW0iLCJvdXRwdXRfc3RyZWFtIiwiY29kZV9wb2ludCIsInJlc3VsdCIsInN1YnN0cmluZyIsIm9wdF9zdHJpbmciLCJlbmNvZGVyIiwiVVRGOEVuY29kZXIiLCJsYXN0X2J5dGUiLCJVaW50OEFycmF5IiwidXRmOF9jb2RlX3BvaW50IiwidXRmOF9ieXRlc19uZWVkZWQiLCJ1dGY4X2J5dGVzX3NlZW4iLCJ1dGY4X2xvd2VyX2JvdW5kYXJ5IiwiYnl0ZV9wb2ludGVyIiwiYml0ZSIsIk1hdGgiLCJwb3ciLCJsb3dlcl9ib3VuZGFyeSIsIm91dHB1dF9ieXRlX3N0cmVhbSIsImNvZGVfcG9pbnRfcG9pbnRlciIsImNvdW50IiwiZGl2IiwidGVtcCIsIm1pbiIsIm1heCIsImZsb29yIl0sIm1hcHBpbmdzIjoiOzs7OztRQTZHZ0JBLE0sR0FBQUEsTTtRQTRCQUMsTSxHQUFBQSxNO0FBekloQjs7QUFFQSxJQUFNQyxlQUFlLE1BQXJCOztBQUVBLElBQUlDLFdBQVcsQ0FBQyxDQUFoQjtBQUNBLElBQUlDLGlCQUFpQixDQUFDLENBQXRCOztBQUVBLFNBQVNDLGVBQVQsQ0FBMEJDLEtBQTFCLEVBQWlDO0FBQy9CLE1BQUlDLE1BQU0sQ0FBVjs7QUFFQSxPQUFLQyxHQUFMLEdBQVcsWUFBWTtBQUNyQixXQUFRRCxPQUFPRCxNQUFNRyxNQUFkLEdBQXdCTixRQUF4QixHQUFtQ08sT0FBT0osTUFBTUMsR0FBTixDQUFQLENBQTFDO0FBQ0QsR0FGRDs7QUFJQSxPQUFLSSxNQUFMLEdBQWMsVUFBVUMsQ0FBVixFQUFhO0FBQ3pCTCxXQUFPSyxDQUFQO0FBQ0EsUUFBSUwsTUFBTSxDQUFWLEVBQWE7QUFDWCxZQUFNLElBQUlNLEtBQUosQ0FBVSxrQ0FBVixDQUFOO0FBQ0Q7QUFDRCxRQUFJTixNQUFNRCxNQUFNRyxNQUFoQixFQUF3QjtBQUN0QixZQUFNLElBQUlJLEtBQUosQ0FBVSxrQkFBVixDQUFOO0FBQ0Q7QUFDRixHQVJEO0FBU0Q7O0FBRUQsU0FBU0MsZ0JBQVQsQ0FBMkJSLEtBQTNCLEVBQWtDO0FBQ2hDLE1BQUlDLE1BQU0sQ0FBVjs7QUFFQSxPQUFLUSxJQUFMLEdBQVksVUFBVUMsUUFBVixFQUFvQjtBQUM5QixRQUFJQyxPQUFPZCxRQUFYO0FBQ0EsUUFBSWUsQ0FBSjtBQUNBLFNBQUtBLElBQUksQ0FBVCxFQUFZQSxJQUFJQyxVQUFVVixNQUExQixFQUFrQyxFQUFFUyxDQUFwQyxFQUF1QztBQUNyQ0QsYUFBT1AsT0FBT1MsVUFBVUQsQ0FBVixDQUFQLENBQVA7QUFDQVosWUFBTUMsS0FBTixJQUFlVSxJQUFmO0FBQ0Q7QUFDRCxXQUFPQSxJQUFQO0FBQ0QsR0FSRDtBQVNEOztBQUVELFNBQVNHLG9CQUFULENBQStCQyxNQUEvQixFQUF1QztBQUNyQyxXQUFTQyxrQkFBVCxDQUE2QkQsTUFBN0IsRUFBcUM7QUFDbkMsUUFBSUUsTUFBTSxFQUFWO0FBQ0EsUUFBSUwsSUFBSSxDQUFSO0FBQ0EsUUFBSU4sSUFBSVMsT0FBT1osTUFBZjtBQUNBLFdBQU9TLElBQUlHLE9BQU9aLE1BQWxCLEVBQTBCO0FBQ3hCLFVBQUllLElBQUlILE9BQU9JLFVBQVAsQ0FBa0JQLENBQWxCLENBQVI7QUFDQSxVQUFJLENBQUNRLFFBQVFGLENBQVIsRUFBVyxNQUFYLEVBQW1CLE1BQW5CLENBQUwsRUFBaUM7QUFDL0JELFlBQUlJLElBQUosQ0FBU0gsQ0FBVDtBQUNELE9BRkQsTUFFTyxJQUFJRSxRQUFRRixDQUFSLEVBQVcsTUFBWCxFQUFtQixNQUFuQixDQUFKLEVBQWdDO0FBQ3JDRCxZQUFJSSxJQUFKLENBQVMsTUFBVDtBQUNELE9BRk0sTUFFQTtBQUFFO0FBQ1AsWUFBSVQsTUFBTU4sSUFBSSxDQUFkLEVBQWlCO0FBQ2ZXLGNBQUlJLElBQUosQ0FBUyxNQUFUO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsY0FBSUMsSUFBSVAsT0FBT0ksVUFBUCxDQUFrQlAsSUFBSSxDQUF0QixDQUFSO0FBQ0EsY0FBSVEsUUFBUUUsQ0FBUixFQUFXLE1BQVgsRUFBbUIsTUFBbkIsQ0FBSixFQUFnQztBQUM5QixnQkFBSUMsSUFBSUwsSUFBSSxLQUFaO0FBQ0EsZ0JBQUlNLElBQUlGLElBQUksS0FBWjtBQUNBVixpQkFBSyxDQUFMO0FBQ0FLLGdCQUFJSSxJQUFKLENBQVMsV0FBV0UsS0FBSyxFQUFoQixJQUFzQkMsQ0FBL0I7QUFDRCxXQUxELE1BS087QUFDTFAsZ0JBQUlJLElBQUosQ0FBUyxNQUFUO0FBQ0Q7QUFDRjtBQUNGO0FBQ0RULFdBQUssQ0FBTDtBQUNEO0FBQ0QsV0FBT0ssR0FBUDtBQUNEOztBQUVELE1BQUloQixNQUFNLENBQVY7QUFDQSxNQUFJZ0IsTUFBTUQsbUJBQW1CRCxNQUFuQixDQUFWOztBQUVBLE9BQUtWLE1BQUwsR0FBYyxVQUFVQyxDQUFWLEVBQWE7QUFDekJMLFdBQU9LLENBQVA7QUFDQSxRQUFJTCxNQUFNLENBQVYsRUFBYTtBQUNYLFlBQU0sSUFBSU0sS0FBSixDQUFVLGtDQUFWLENBQU47QUFDRDtBQUNELFFBQUlOLE1BQU1nQixJQUFJZCxNQUFkLEVBQXNCO0FBQ3BCLFlBQU0sSUFBSUksS0FBSixDQUFVLGtCQUFWLENBQU47QUFDRDtBQUNGLEdBUkQ7O0FBVUEsT0FBS0wsR0FBTCxHQUFXLFlBQVk7QUFDckIsUUFBSUQsT0FBT2dCLElBQUlkLE1BQWYsRUFBdUI7QUFDckIsYUFBT0wsY0FBUDtBQUNEO0FBQ0QsV0FBT21CLElBQUloQixHQUFKLENBQVA7QUFDRCxHQUxEO0FBTUQ7O0FBRUQsU0FBU3dCLHFCQUFULEdBQWtDO0FBQ2hDLE1BQUlWLFNBQVMsRUFBYjs7QUFFQSxPQUFLQSxNQUFMLEdBQWMsWUFBWTtBQUN4QixXQUFPQSxNQUFQO0FBQ0QsR0FGRDs7QUFJQSxPQUFLTixJQUFMLEdBQVksVUFBVVMsQ0FBVixFQUFhO0FBQ3ZCLFFBQUlBLEtBQUssTUFBVCxFQUFpQjtBQUNmSCxnQkFBVVcsT0FBT0MsWUFBUCxDQUFvQlQsQ0FBcEIsQ0FBVjtBQUNELEtBRkQsTUFFTztBQUNMQSxXQUFLLE9BQUw7QUFDQUgsZ0JBQVVXLE9BQU9DLFlBQVAsQ0FBb0IsVUFBV1QsS0FBSyxFQUFOLEdBQVksS0FBdEIsQ0FBcEIsQ0FBVjtBQUNBSCxnQkFBVVcsT0FBT0MsWUFBUCxDQUFvQixVQUFVVCxJQUFJLEtBQWQsQ0FBcEIsQ0FBVjtBQUNEO0FBQ0YsR0FSRDtBQVNEOztBQUVNLFNBQVN4QixNQUFULENBQWlCTSxLQUFqQixFQUF3QjtBQUM3QixNQUFNNEIsVUFBVSxJQUFJQyxXQUFKLEVBQWhCO0FBQ0EsTUFBSUMsZUFBZSxJQUFJL0IsZUFBSixDQUFvQkMsS0FBcEIsQ0FBbkI7QUFDQSxNQUFJK0IsZ0JBQWdCLElBQUlOLHFCQUFKLEVBQXBCOztBQUVBLFNBQU9LLGFBQWE1QixHQUFiLE9BQXVCTCxRQUE5QixFQUF3QztBQUN0QyxRQUFJbUMsY0FBYUosUUFBUWxDLE1BQVIsQ0FBZW9DLFlBQWYsQ0FBakI7QUFDQSxRQUFJRSxnQkFBZSxJQUFmLElBQXVCQSxnQkFBZWxDLGNBQTFDLEVBQTBEO0FBQ3hEaUMsb0JBQWN0QixJQUFkLENBQW1CdUIsV0FBbkI7QUFDRDtBQUNGOztBQUVELE1BQUlBLG1CQUFKO0FBQ0EsS0FBRztBQUNEQSxpQkFBYUosUUFBUWxDLE1BQVIsQ0FBZW9DLFlBQWYsQ0FBYjtBQUNBLFFBQUlFLGVBQWUsSUFBZixJQUF1QkEsZUFBZWxDLGNBQTFDLEVBQTBEO0FBQ3hEaUMsb0JBQWN0QixJQUFkLENBQW1CdUIsVUFBbkI7QUFDRDtBQUNGLEdBTEQsUUFLU0EsZUFBZWxDLGNBQWYsSUFBaUNnQyxhQUFhNUIsR0FBYixPQUF1QkwsUUFMakU7O0FBT0EsTUFBSW9DLFNBQVNGLGNBQWNoQixNQUFkLEVBQWI7QUFDQSxNQUFJa0IsT0FBT2QsVUFBUCxDQUFrQixDQUFsQixNQUF5QixNQUE3QixFQUFxQztBQUNuQ2MsYUFBU0EsT0FBT0MsU0FBUCxDQUFpQixDQUFqQixDQUFUO0FBQ0Q7O0FBRUQsU0FBT0QsTUFBUDtBQUNEOztBQUVNLFNBQVN0QyxNQUFULENBQWlCd0MsVUFBakIsRUFBNkI7QUFDbEMsTUFBTUMsVUFBVSxJQUFJQyxXQUFKLEVBQWhCOztBQUVBLE1BQUlyQyxRQUFRLEVBQVo7QUFDQSxNQUFJK0IsZ0JBQWdCLElBQUl2QixnQkFBSixDQUFxQlIsS0FBckIsQ0FBcEI7QUFDQSxNQUFJOEIsZUFBZSxJQUFJaEIsb0JBQUosQ0FBeUJxQixVQUF6QixDQUFuQjtBQUNBLFNBQU9MLGFBQWE1QixHQUFiLE9BQXVCSixjQUE5QixFQUE4QztBQUM1Q3NDLFlBQVF6QyxNQUFSLENBQWVvQyxhQUFmLEVBQThCRCxZQUE5QjtBQUNEO0FBQ0QsTUFBSVEsU0FBSjtBQUNBLEtBQUc7QUFDREEsZ0JBQVlGLFFBQVF6QyxNQUFSLENBQWVvQyxhQUFmLEVBQThCRCxZQUE5QixDQUFaO0FBQ0QsR0FGRCxRQUVTUSxjQUFjekMsUUFGdkI7QUFHQSxTQUFPLElBQUkwQyxVQUFKLENBQWV2QyxLQUFmLENBQVA7QUFDRDs7QUFFRCxTQUFTNkIsV0FBVCxHQUF3QjtBQUN0QixNQUFJVyxrQkFBa0IsQ0FBdEI7QUFDQSxNQUFJQyxvQkFBb0IsQ0FBeEI7QUFDQSxNQUFJQyxrQkFBa0IsQ0FBdEI7QUFDQSxNQUFJQyxzQkFBc0IsQ0FBMUI7O0FBRUEsT0FBS2pELE1BQUwsR0FBYyxVQUFVa0QsWUFBVixFQUF3QjtBQUNwQyxRQUFJQyxPQUFPRCxhQUFhMUMsR0FBYixFQUFYO0FBQ0EsUUFBSTJDLFNBQVNoRCxRQUFiLEVBQXVCO0FBQ3JCLFVBQUk0QyxzQkFBc0IsQ0FBMUIsRUFBNkI7QUFDM0IsZUFBTzdDLFlBQVA7QUFDRDtBQUNELGFBQU9FLGNBQVA7QUFDRDtBQUNEOEMsaUJBQWF2QyxNQUFiLENBQW9CLENBQXBCOztBQUVBLFFBQUlvQyxzQkFBc0IsQ0FBMUIsRUFBNkI7QUFDM0IsVUFBSXJCLFFBQVF5QixJQUFSLEVBQWMsSUFBZCxFQUFvQixJQUFwQixDQUFKLEVBQStCO0FBQzdCLGVBQU9BLElBQVA7QUFDRDtBQUNELFVBQUl6QixRQUFReUIsSUFBUixFQUFjLElBQWQsRUFBb0IsSUFBcEIsQ0FBSixFQUErQjtBQUM3QkosNEJBQW9CLENBQXBCO0FBQ0FFLDhCQUFzQixJQUF0QjtBQUNBSCwwQkFBa0JLLE9BQU8sSUFBekI7QUFDRCxPQUpELE1BSU8sSUFBSXpCLFFBQVF5QixJQUFSLEVBQWMsSUFBZCxFQUFvQixJQUFwQixDQUFKLEVBQStCO0FBQ3BDSiw0QkFBb0IsQ0FBcEI7QUFDQUUsOEJBQXNCLEtBQXRCO0FBQ0FILDBCQUFrQkssT0FBTyxJQUF6QjtBQUNELE9BSk0sTUFJQSxJQUFJekIsUUFBUXlCLElBQVIsRUFBYyxJQUFkLEVBQW9CLElBQXBCLENBQUosRUFBK0I7QUFDcENKLDRCQUFvQixDQUFwQjtBQUNBRSw4QkFBc0IsT0FBdEI7QUFDQUgsMEJBQWtCSyxPQUFPLElBQXpCO0FBQ0QsT0FKTSxNQUlBO0FBQ0wsZUFBT2pELFlBQVA7QUFDRDtBQUNENEMsd0JBQWtCQSxrQkFBa0JNLEtBQUtDLEdBQUwsQ0FBUyxFQUFULEVBQWFOLGlCQUFiLENBQXBDO0FBQ0EsYUFBTyxJQUFQO0FBQ0Q7QUFDRCxRQUFJLENBQUNyQixRQUFReUIsSUFBUixFQUFjLElBQWQsRUFBb0IsSUFBcEIsQ0FBTCxFQUFnQztBQUM5Qkwsd0JBQWtCLENBQWxCO0FBQ0FDLDBCQUFvQixDQUFwQjtBQUNBQyx3QkFBa0IsQ0FBbEI7QUFDQUMsNEJBQXNCLENBQXRCO0FBQ0FDLG1CQUFhdkMsTUFBYixDQUFvQixDQUFDLENBQXJCO0FBQ0EsYUFBT1QsWUFBUDtBQUNEO0FBQ0Q4Qyx1QkFBbUIsQ0FBbkI7QUFDQUYsc0JBQWtCQSxrQkFBa0IsQ0FBQ0ssT0FBTyxJQUFSLElBQWdCQyxLQUFLQyxHQUFMLENBQVMsRUFBVCxFQUFhTixvQkFBb0JDLGVBQWpDLENBQXBEO0FBQ0EsUUFBSUEsb0JBQW9CRCxpQkFBeEIsRUFBMkM7QUFDekMsYUFBTyxJQUFQO0FBQ0Q7QUFDRCxRQUFJVCxhQUFhUSxlQUFqQjtBQUNBLFFBQUlRLGlCQUFpQkwsbUJBQXJCO0FBQ0FILHNCQUFrQixDQUFsQjtBQUNBQyx3QkFBb0IsQ0FBcEI7QUFDQUMsc0JBQWtCLENBQWxCO0FBQ0FDLDBCQUFzQixDQUF0QjtBQUNBLFFBQUl2QixRQUFRWSxVQUFSLEVBQW9CZ0IsY0FBcEIsRUFBb0MsUUFBcEMsS0FBaUQsQ0FBQzVCLFFBQVFZLFVBQVIsRUFBb0IsTUFBcEIsRUFBNEIsTUFBNUIsQ0FBdEQsRUFBMkY7QUFDekYsYUFBT0EsVUFBUDtBQUNEO0FBQ0QsV0FBT3BDLFlBQVA7QUFDRCxHQXZERDtBQXdERDs7QUFFRCxTQUFTeUMsV0FBVCxHQUF3QjtBQUN0QixPQUFLMUMsTUFBTCxHQUFjLFVBQVVzRCxrQkFBVixFQUE4QkMsa0JBQTlCLEVBQWtEO0FBQzlELFFBQUlsQixhQUFha0IsbUJBQW1CaEQsR0FBbkIsRUFBakI7QUFDQSxRQUFJOEIsZUFBZWxDLGNBQW5CLEVBQW1DO0FBQ2pDLGFBQU9ELFFBQVA7QUFDRDtBQUNEcUQsdUJBQW1CN0MsTUFBbkIsQ0FBMEIsQ0FBMUI7QUFDQSxRQUFJZSxRQUFRWSxVQUFSLEVBQW9CLE1BQXBCLEVBQTRCLE1BQTVCLENBQUosRUFBeUM7QUFDdkMsWUFBTSxJQUFJekIsS0FBSixDQUFVLG9CQUFvQnlCLFVBQXBCLEdBQWlDLHdCQUEzQyxDQUFOO0FBQ0Q7QUFDRCxRQUFJWixRQUFRWSxVQUFSLEVBQW9CLE1BQXBCLEVBQTRCLE1BQTVCLENBQUosRUFBeUM7QUFDdkMsYUFBT2lCLG1CQUFtQnhDLElBQW5CLENBQXdCdUIsVUFBeEIsQ0FBUDtBQUNEO0FBQ0QsUUFBSW1CLEtBQUosRUFBVzlDLE1BQVg7QUFDQSxRQUFJZSxRQUFRWSxVQUFSLEVBQW9CLE1BQXBCLEVBQTRCLE1BQTVCLENBQUosRUFBeUM7QUFDdkNtQixjQUFRLENBQVI7QUFDQTlDLGVBQVMsSUFBVDtBQUNELEtBSEQsTUFHTyxJQUFJZSxRQUFRWSxVQUFSLEVBQW9CLE1BQXBCLEVBQTRCLE1BQTVCLENBQUosRUFBeUM7QUFDOUNtQixjQUFRLENBQVI7QUFDQTlDLGVBQVMsSUFBVDtBQUNELEtBSE0sTUFHQSxJQUFJZSxRQUFRWSxVQUFSLEVBQW9CLE9BQXBCLEVBQTZCLFFBQTdCLENBQUosRUFBNEM7QUFDakRtQixjQUFRLENBQVI7QUFDQTlDLGVBQVMsSUFBVDtBQUNEO0FBQ0QsUUFBSTRCLFNBQVNnQixtQkFBbUJ4QyxJQUFuQixDQUF3QjJDLElBQUlwQixVQUFKLEVBQWdCYyxLQUFLQyxHQUFMLENBQVMsRUFBVCxFQUFhSSxLQUFiLENBQWhCLElBQXVDOUMsTUFBL0QsQ0FBYjtBQUNBLFdBQU84QyxRQUFRLENBQWYsRUFBa0I7QUFDaEIsVUFBSUUsT0FBT0QsSUFBSXBCLFVBQUosRUFBZ0JjLEtBQUtDLEdBQUwsQ0FBUyxFQUFULEVBQWFJLFFBQVEsQ0FBckIsQ0FBaEIsQ0FBWDtBQUNBbEIsZUFBU2dCLG1CQUFtQnhDLElBQW5CLENBQXdCLE9BQVE0QyxPQUFPLEVBQXZDLENBQVQ7QUFDQUYsZUFBUyxDQUFUO0FBQ0Q7QUFDRCxXQUFPbEIsTUFBUDtBQUNELEdBOUJEO0FBK0JEOztBQUVELFNBQVNiLE9BQVQsQ0FBa0JHLENBQWxCLEVBQXFCK0IsR0FBckIsRUFBMEJDLEdBQTFCLEVBQStCO0FBQzdCLFNBQU9ELE9BQU8vQixDQUFQLElBQVlBLEtBQUtnQyxHQUF4QjtBQUNEOztBQUVELFNBQVNILEdBQVQsQ0FBYzlDLENBQWQsRUFBaUJnQixDQUFqQixFQUFvQjtBQUNsQixTQUFPd0IsS0FBS1UsS0FBTCxDQUFXbEQsSUFBSWdCLENBQWYsQ0FBUDtBQUNEIiwiZmlsZSI6InN0cmluZ2VuY29kaW5nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgY2FtZWxjYXNlICovXG5cbmNvbnN0IEVSUk9SX1NZTUJPTCA9IDB4RkZGRFxuXG52YXIgRU9GX2J5dGUgPSAtMVxudmFyIEVPRl9jb2RlX3BvaW50ID0gLTFcblxuZnVuY3Rpb24gQnl0ZUlucHV0U3RyZWFtIChieXRlcykge1xuICB2YXIgcG9zID0gMFxuXG4gIHRoaXMuZ2V0ID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiAocG9zID49IGJ5dGVzLmxlbmd0aCkgPyBFT0ZfYnl0ZSA6IE51bWJlcihieXRlc1twb3NdKVxuICB9XG5cbiAgdGhpcy5vZmZzZXQgPSBmdW5jdGlvbiAobikge1xuICAgIHBvcyArPSBuXG4gICAgaWYgKHBvcyA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2Vla2luZyBwYXN0IHN0YXJ0IG9mIHRoZSBidWZmZXInKVxuICAgIH1cbiAgICBpZiAocG9zID4gYnl0ZXMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBFT0YnKVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBCeXRlT3V0cHV0U3RyZWFtIChieXRlcykge1xuICB2YXIgcG9zID0gMFxuXG4gIHRoaXMuZW1pdCA9IGZ1bmN0aW9uICh2YXJfYXJncykge1xuICAgIHZhciBsYXN0ID0gRU9GX2J5dGVcbiAgICB2YXIgaVxuICAgIGZvciAoaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHtcbiAgICAgIGxhc3QgPSBOdW1iZXIoYXJndW1lbnRzW2ldKVxuICAgICAgYnl0ZXNbcG9zKytdID0gbGFzdFxuICAgIH1cbiAgICByZXR1cm4gbGFzdFxuICB9XG59XG5cbmZ1bmN0aW9uIENvZGVQb2ludElucHV0U3RyZWFtIChzdHJpbmcpIHtcbiAgZnVuY3Rpb24gc3RyaW5nVG9Db2RlUG9pbnRzIChzdHJpbmcpIHtcbiAgICB2YXIgY3BzID0gW11cbiAgICB2YXIgaSA9IDBcbiAgICB2YXIgbiA9IHN0cmluZy5sZW5ndGhcbiAgICB3aGlsZSAoaSA8IHN0cmluZy5sZW5ndGgpIHtcbiAgICAgIHZhciBjID0gc3RyaW5nLmNoYXJDb2RlQXQoaSlcbiAgICAgIGlmICghaW5SYW5nZShjLCAweEQ4MDAsIDB4REZGRikpIHtcbiAgICAgICAgY3BzLnB1c2goYylcbiAgICAgIH0gZWxzZSBpZiAoaW5SYW5nZShjLCAweERDMDAsIDB4REZGRikpIHtcbiAgICAgICAgY3BzLnB1c2goMHhGRkZEKVxuICAgICAgfSBlbHNlIHsgLy8gKGluUmFuZ2UoY3UsIDB4RDgwMCwgMHhEQkZGKSlcbiAgICAgICAgaWYgKGkgPT09IG4gLSAxKSB7XG4gICAgICAgICAgY3BzLnB1c2goMHhGRkZEKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZhciBkID0gc3RyaW5nLmNoYXJDb2RlQXQoaSArIDEpXG4gICAgICAgICAgaWYgKGluUmFuZ2UoZCwgMHhEQzAwLCAweERGRkYpKSB7XG4gICAgICAgICAgICB2YXIgYSA9IGMgJiAweDNGRlxuICAgICAgICAgICAgdmFyIGIgPSBkICYgMHgzRkZcbiAgICAgICAgICAgIGkgKz0gMVxuICAgICAgICAgICAgY3BzLnB1c2goMHgxMDAwMCArIChhIDw8IDEwKSArIGIpXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNwcy5wdXNoKDB4RkZGRClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGkgKz0gMVxuICAgIH1cbiAgICByZXR1cm4gY3BzXG4gIH1cblxuICB2YXIgcG9zID0gMFxuICB2YXIgY3BzID0gc3RyaW5nVG9Db2RlUG9pbnRzKHN0cmluZylcblxuICB0aGlzLm9mZnNldCA9IGZ1bmN0aW9uIChuKSB7XG4gICAgcG9zICs9IG5cbiAgICBpZiAocG9zIDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZWVraW5nIHBhc3Qgc3RhcnQgb2YgdGhlIGJ1ZmZlcicpXG4gICAgfVxuICAgIGlmIChwb3MgPiBjcHMubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlZWtpbmcgcGFzdCBFT0YnKVxuICAgIH1cbiAgfVxuXG4gIHRoaXMuZ2V0ID0gZnVuY3Rpb24gKCkge1xuICAgIGlmIChwb3MgPj0gY3BzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50XG4gICAgfVxuICAgIHJldHVybiBjcHNbcG9zXVxuICB9XG59XG5cbmZ1bmN0aW9uIENvZGVQb2ludE91dHB1dFN0cmVhbSAoKSB7XG4gIHZhciBzdHJpbmcgPSAnJ1xuXG4gIHRoaXMuc3RyaW5nID0gZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBzdHJpbmdcbiAgfVxuXG4gIHRoaXMuZW1pdCA9IGZ1bmN0aW9uIChjKSB7XG4gICAgaWYgKGMgPD0gMHhGRkZGKSB7XG4gICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKVxuICAgIH0gZWxzZSB7XG4gICAgICBjIC09IDB4MTAwMDBcbiAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4RDgwMCArICgoYyA+PiAxMCkgJiAweDNmZikpXG4gICAgICBzdHJpbmcgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgweERDMDAgKyAoYyAmIDB4M2ZmKSlcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZSAoYnl0ZXMpIHtcbiAgY29uc3QgZGVjb2RlciA9IG5ldyBVVEY4RGVjb2RlcigpXG4gIHZhciBpbnB1dF9zdHJlYW0gPSBuZXcgQnl0ZUlucHV0U3RyZWFtKGJ5dGVzKVxuICB2YXIgb3V0cHV0X3N0cmVhbSA9IG5ldyBDb2RlUG9pbnRPdXRwdXRTdHJlYW0oKVxuXG4gIHdoaWxlIChpbnB1dF9zdHJlYW0uZ2V0KCkgIT09IEVPRl9ieXRlKSB7XG4gICAgbGV0IGNvZGVfcG9pbnQgPSBkZWNvZGVyLmRlY29kZShpbnB1dF9zdHJlYW0pXG4gICAgaWYgKGNvZGVfcG9pbnQgIT09IG51bGwgJiYgY29kZV9wb2ludCAhPT0gRU9GX2NvZGVfcG9pbnQpIHtcbiAgICAgIG91dHB1dF9zdHJlYW0uZW1pdChjb2RlX3BvaW50KVxuICAgIH1cbiAgfVxuXG4gIGxldCBjb2RlX3BvaW50XG4gIGRvIHtcbiAgICBjb2RlX3BvaW50ID0gZGVjb2Rlci5kZWNvZGUoaW5wdXRfc3RyZWFtKVxuICAgIGlmIChjb2RlX3BvaW50ICE9PSBudWxsICYmIGNvZGVfcG9pbnQgIT09IEVPRl9jb2RlX3BvaW50KSB7XG4gICAgICBvdXRwdXRfc3RyZWFtLmVtaXQoY29kZV9wb2ludClcbiAgICB9XG4gIH0gd2hpbGUgKGNvZGVfcG9pbnQgIT09IEVPRl9jb2RlX3BvaW50ICYmIGlucHV0X3N0cmVhbS5nZXQoKSAhPT0gRU9GX2J5dGUpXG5cbiAgdmFyIHJlc3VsdCA9IG91dHB1dF9zdHJlYW0uc3RyaW5nKClcbiAgaWYgKHJlc3VsdC5jaGFyQ29kZUF0KDApID09PSAweEZFRkYpIHtcbiAgICByZXN1bHQgPSByZXN1bHQuc3Vic3RyaW5nKDEpXG4gIH1cblxuICByZXR1cm4gcmVzdWx0XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbmNvZGUgKG9wdF9zdHJpbmcpIHtcbiAgY29uc3QgZW5jb2RlciA9IG5ldyBVVEY4RW5jb2RlcigpXG5cbiAgdmFyIGJ5dGVzID0gW11cbiAgdmFyIG91dHB1dF9zdHJlYW0gPSBuZXcgQnl0ZU91dHB1dFN0cmVhbShieXRlcylcbiAgdmFyIGlucHV0X3N0cmVhbSA9IG5ldyBDb2RlUG9pbnRJbnB1dFN0cmVhbShvcHRfc3RyaW5nKVxuICB3aGlsZSAoaW5wdXRfc3RyZWFtLmdldCgpICE9PSBFT0ZfY29kZV9wb2ludCkge1xuICAgIGVuY29kZXIuZW5jb2RlKG91dHB1dF9zdHJlYW0sIGlucHV0X3N0cmVhbSlcbiAgfVxuICB2YXIgbGFzdF9ieXRlXG4gIGRvIHtcbiAgICBsYXN0X2J5dGUgPSBlbmNvZGVyLmVuY29kZShvdXRwdXRfc3RyZWFtLCBpbnB1dF9zdHJlYW0pXG4gIH0gd2hpbGUgKGxhc3RfYnl0ZSAhPT0gRU9GX2J5dGUpXG4gIHJldHVybiBuZXcgVWludDhBcnJheShieXRlcylcbn1cblxuZnVuY3Rpb24gVVRGOERlY29kZXIgKCkge1xuICB2YXIgdXRmOF9jb2RlX3BvaW50ID0gMFxuICB2YXIgdXRmOF9ieXRlc19uZWVkZWQgPSAwXG4gIHZhciB1dGY4X2J5dGVzX3NlZW4gPSAwXG4gIHZhciB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMFxuXG4gIHRoaXMuZGVjb2RlID0gZnVuY3Rpb24gKGJ5dGVfcG9pbnRlcikge1xuICAgIHZhciBiaXRlID0gYnl0ZV9wb2ludGVyLmdldCgpXG4gICAgaWYgKGJpdGUgPT09IEVPRl9ieXRlKSB7XG4gICAgICBpZiAodXRmOF9ieXRlc19uZWVkZWQgIT09IDApIHtcbiAgICAgICAgcmV0dXJuIEVSUk9SX1NZTUJPTFxuICAgICAgfVxuICAgICAgcmV0dXJuIEVPRl9jb2RlX3BvaW50XG4gICAgfVxuICAgIGJ5dGVfcG9pbnRlci5vZmZzZXQoMSlcblxuICAgIGlmICh1dGY4X2J5dGVzX25lZWRlZCA9PT0gMCkge1xuICAgICAgaWYgKGluUmFuZ2UoYml0ZSwgMHgwMCwgMHg3RikpIHtcbiAgICAgICAgcmV0dXJuIGJpdGVcbiAgICAgIH1cbiAgICAgIGlmIChpblJhbmdlKGJpdGUsIDB4QzIsIDB4REYpKSB7XG4gICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMVxuICAgICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMHg4MFxuICAgICAgICB1dGY4X2NvZGVfcG9pbnQgPSBiaXRlIC0gMHhDMFxuICAgICAgfSBlbHNlIGlmIChpblJhbmdlKGJpdGUsIDB4RTAsIDB4RUYpKSB7XG4gICAgICAgIHV0ZjhfYnl0ZXNfbmVlZGVkID0gMlxuICAgICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMHg4MDBcbiAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4RTBcbiAgICAgIH0gZWxzZSBpZiAoaW5SYW5nZShiaXRlLCAweEYwLCAweEY0KSkge1xuICAgICAgICB1dGY4X2J5dGVzX25lZWRlZCA9IDNcbiAgICAgICAgdXRmOF9sb3dlcl9ib3VuZGFyeSA9IDB4MTAwMDBcbiAgICAgICAgdXRmOF9jb2RlX3BvaW50ID0gYml0ZSAtIDB4RjBcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBFUlJPUl9TWU1CT0xcbiAgICAgIH1cbiAgICAgIHV0ZjhfY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludCAqIE1hdGgucG93KDY0LCB1dGY4X2J5dGVzX25lZWRlZClcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICAgIGlmICghaW5SYW5nZShiaXRlLCAweDgwLCAweEJGKSkge1xuICAgICAgdXRmOF9jb2RlX3BvaW50ID0gMFxuICAgICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwXG4gICAgICB1dGY4X2J5dGVzX3NlZW4gPSAwXG4gICAgICB1dGY4X2xvd2VyX2JvdW5kYXJ5ID0gMFxuICAgICAgYnl0ZV9wb2ludGVyLm9mZnNldCgtMSlcbiAgICAgIHJldHVybiBFUlJPUl9TWU1CT0xcbiAgICB9XG4gICAgdXRmOF9ieXRlc19zZWVuICs9IDFcbiAgICB1dGY4X2NvZGVfcG9pbnQgPSB1dGY4X2NvZGVfcG9pbnQgKyAoYml0ZSAtIDB4ODApICogTWF0aC5wb3coNjQsIHV0ZjhfYnl0ZXNfbmVlZGVkIC0gdXRmOF9ieXRlc19zZWVuKVxuICAgIGlmICh1dGY4X2J5dGVzX3NlZW4gIT09IHV0ZjhfYnl0ZXNfbmVlZGVkKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICB2YXIgY29kZV9wb2ludCA9IHV0ZjhfY29kZV9wb2ludFxuICAgIHZhciBsb3dlcl9ib3VuZGFyeSA9IHV0ZjhfbG93ZXJfYm91bmRhcnlcbiAgICB1dGY4X2NvZGVfcG9pbnQgPSAwXG4gICAgdXRmOF9ieXRlc19uZWVkZWQgPSAwXG4gICAgdXRmOF9ieXRlc19zZWVuID0gMFxuICAgIHV0ZjhfbG93ZXJfYm91bmRhcnkgPSAwXG4gICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgbG93ZXJfYm91bmRhcnksIDB4MTBGRkZGKSAmJiAhaW5SYW5nZShjb2RlX3BvaW50LCAweEQ4MDAsIDB4REZGRikpIHtcbiAgICAgIHJldHVybiBjb2RlX3BvaW50XG4gICAgfVxuICAgIHJldHVybiBFUlJPUl9TWU1CT0xcbiAgfVxufVxuXG5mdW5jdGlvbiBVVEY4RW5jb2RlciAoKSB7XG4gIHRoaXMuZW5jb2RlID0gZnVuY3Rpb24gKG91dHB1dF9ieXRlX3N0cmVhbSwgY29kZV9wb2ludF9wb2ludGVyKSB7XG4gICAgdmFyIGNvZGVfcG9pbnQgPSBjb2RlX3BvaW50X3BvaW50ZXIuZ2V0KClcbiAgICBpZiAoY29kZV9wb2ludCA9PT0gRU9GX2NvZGVfcG9pbnQpIHtcbiAgICAgIHJldHVybiBFT0ZfYnl0ZVxuICAgIH1cbiAgICBjb2RlX3BvaW50X3BvaW50ZXIub2Zmc2V0KDEpXG4gICAgaWYgKGluUmFuZ2UoY29kZV9wb2ludCwgMHhEODAwLCAweERGRkYpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjb2RlIHBvaW50ICcgKyBjb2RlX3BvaW50ICsgJyBjb3VsZCBub3QgYmUgZW5jb2RlZC4nKVxuICAgIH1cbiAgICBpZiAoaW5SYW5nZShjb2RlX3BvaW50LCAweDAwMDAsIDB4MDA3ZikpIHtcbiAgICAgIHJldHVybiBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChjb2RlX3BvaW50KVxuICAgIH1cbiAgICB2YXIgY291bnQsIG9mZnNldFxuICAgIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDA4MCwgMHgwN0ZGKSkge1xuICAgICAgY291bnQgPSAxXG4gICAgICBvZmZzZXQgPSAweEMwXG4gICAgfSBlbHNlIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MDgwMCwgMHhGRkZGKSkge1xuICAgICAgY291bnQgPSAyXG4gICAgICBvZmZzZXQgPSAweEUwXG4gICAgfSBlbHNlIGlmIChpblJhbmdlKGNvZGVfcG9pbnQsIDB4MTAwMDAsIDB4MTBGRkZGKSkge1xuICAgICAgY291bnQgPSAzXG4gICAgICBvZmZzZXQgPSAweEYwXG4gICAgfVxuICAgIHZhciByZXN1bHQgPSBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdChkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50KSkgKyBvZmZzZXQpXG4gICAgd2hpbGUgKGNvdW50ID4gMCkge1xuICAgICAgdmFyIHRlbXAgPSBkaXYoY29kZV9wb2ludCwgTWF0aC5wb3coNjQsIGNvdW50IC0gMSkpXG4gICAgICByZXN1bHQgPSBvdXRwdXRfYnl0ZV9zdHJlYW0uZW1pdCgweDgwICsgKHRlbXAgJSA2NCkpXG4gICAgICBjb3VudCAtPSAxXG4gICAgfVxuICAgIHJldHVybiByZXN1bHRcbiAgfVxufVxuXG5mdW5jdGlvbiBpblJhbmdlIChhLCBtaW4sIG1heCkge1xuICByZXR1cm4gbWluIDw9IGEgJiYgYSA8PSBtYXhcbn1cblxuZnVuY3Rpb24gZGl2IChuLCBkKSB7XG4gIHJldHVybiBNYXRoLmZsb29yKG4gLyBkKVxufVxuIl19